// services/ProductService.js
// NutraDetective - Evidence-Based Nutritional Scoring System
// Version 2.5 - Enhanced Harmful Additives Detection
// INCLUDES: Nutritionix Fix, Spoonacular API, Enhanced Scoring, Complete Harmful Detection

import { getAdditiveInfo } from './additives-database';
import { HARMFUL_INGREDIENTS_DATABASE } from './harmful-ingredients-master';

// Generic placeholder image for products without images
const PLACEHOLDER_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxyZWN0IHg9IjQwIiB5PSI1MCIgd2lkdGg9IjgiIGhlaWdodD0iODAiIGZpbGw9IiM5Q0EzQUYiLz4KPHJlY3QgeD0iNTIiIHk9IjUwIiB3aWR0aD0iNCIgaGVpZ2h0PSI4MCIgZmlsbD0iIzlDQTNBRiIvPgo8cmVjdCB4PSI2MCIgeT0iNTAiIHdpZHRoPSI4IiBoZWlnaHQ9IjgwIiBmaWxsPSIjOUNBM0FGIi8+CjxyZWN0IHg9IjcyIiB5PSI1MCIgd2lkdGg9IjQiIGhlaWdodD0iODAiIGZpbGw9IiM5Q0EzQUYiLz4KPHJlY3QgeD0iODAiIHk9IjUwIiB3aWR0aD0iMTIiIGhlaWdodD0iODAiIGZpbGw9IiM5Q0EzQUYiLz4KPHJlY3QgeD0iOTYiIHk9IjUwIiB3aWR0aD0iNCIgaGVpZ2h0PSI4MCIgZmlsbD0iIzlDQTNBRiIvPgo8cmVjdCB4PSIxMDQiIHk9IjUwIiB3aWR0aD0iOCIgaGVpZ2h0PSI4MCIgZmlsbD0iIzlDQTNBRiIvPgo8cmVjdCB4PSIxMTYiIHk9IjUwIiB3aWR0aD0iNCIgaGVpZ2h0PSI4MCIgZmlsbD0iIzlDQTNBRiIvPgo8cmVjdCB4PSIxMjQiIHk9IjUwIiB3aWR0aD0iOCIgaGVpZ2h0PSI4MCIgZmlsbD0iIzlDQTNBRiIvPgo8cmVjdCB4PSIxMzYiIHk9IjUwIiB3aWR0aD0iNCIgaGVpZ2h0PSI4MCIgZmlsbD0iIzlDQTNBRiIvPgo8cmVjdCB4PSIxNDQiIHk9IjUwIiB3aWR0aD0iOCIgaGVpZ2h0PSI4MCIgZmlsbD0iIzlDQTNBRiIvPgo8cmVjdCB4PSIxNTYiIHk9IjUwIiB3aWR0aD0iNCIgaGVpZ2h0PSI4MCIgZmlsbD0iIzlDQTNBRiIvPgo8dGV4dCB4PSIxMDAiIHk9IjE1NSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNkI3MjgwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBpbWFnZSBhdmFpbGFibGU8L3RleHQ+Cjwvc3ZnPg==';

class ProductService {
  // API Keys - Get these free from each service
  static API_KEYS = {
    USDA: '5QlF40l69GTeey5t3lPgc02BcWOthCTg6ZaAbZW9', // Get from https://fdc.nal.usda.gov/api-key-signup.html
    NUTRITIONIX_ID: '393c1557', // Get from nutritionix.com/business/api
    NUTRITIONIX_KEY: '6cefab30a7a318a0cfb93fa2263ec883',
    SPOONACULAR: '1f66fca067fe49bca59115e88fde84ac', // 150 calls/day free
    EDAMAM_ID: '', // Get from developer.edamam.com
    EDAMAM_KEY: ''
  };

  /**
   * Main function called by App.js - maintains backward compatibility
   * ENHANCED: Now includes product images and detailed additives
   */
  static async fetchProductByBarcode(barcode) {
    console.log('üîç Searching for barcode:', barcode);
    console.log('üìä API Status - USDA Key:', this.API_KEYS.USDA ? 'Present' : 'Missing');
    let product = null;
    let source = '';
    let sourcesUsed = [];

    // Helper to merge nutriments without losing data
    const mergeNutriments = (existing, newData) => {
      if (!newData) return existing || {};
      const merged = { ...(existing || {}) };
      Object.keys(newData).forEach(key => {
        if ((merged[key] === undefined || merged[key] === null) && newData[key] !== undefined) {
          merged[key] = newData[key];
        }
      });
      return merged;
    };

    // Try Open Food Facts first (no API key needed)
    console.log('üì° Trying Open Food Facts...');

    // Add timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);

    try {
      const response = await fetch(
        `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`,
        { signal: controller.signal }
      );
      clearTimeout(timeoutId);
      const data = await response.json();
      console.log('Open Food Facts response status:', data.status);
      
      if (data.status === 1 && data.product) {
        product = data.product;
        source = 'Open Food Facts';
        sourcesUsed.push('Open Food Facts');
        console.log('‚úÖ Found in Open Food Facts:', product.product_name);
      } else {
        console.log('‚ùå Not found in Open Food Facts');
      }
    } catch (error) {
      if (error.name === 'AbortError') {
        console.log('‚è±Ô∏è Open Food Facts timeout - taking too long');
      } else {
        console.error('Open Food Facts error:', error);
      }
    }

    // Check if we need more nutrition data
    const needsMoreData = !product || 
      !product.nutriments?.['sugars_100g'] === undefined ||
      !product.nutriments?.['sodium_100g'] === undefined ||
      !product.nutriments?.['energy-kcal_100g'] === undefined;

    // Try USDA for missing data
    if (needsMoreData && this.API_KEYS.USDA && this.API_KEYS.USDA !== 'DEMO_KEY') {
      try {
        console.log('üì° Trying USDA database...');
        const usdaProduct = await this.fetchFromUSDA(barcode);
        if (usdaProduct) {
          if (!product) {
            product = usdaProduct;
            source = 'USDA';
          } else {
            // Merge missing data
            product.product_name = product.product_name || usdaProduct.product_name;
            product.brands = product.brands || usdaProduct.brands;
            product.ingredients_text = product.ingredients_text || usdaProduct.ingredients_text;
            product.nutriments = mergeNutriments(product.nutriments, usdaProduct.nutriments);
          }
          sourcesUsed.push('USDA');
          console.log('‚úÖ Data from USDA merged');
        } else {
          console.log('‚ùå Not found in USDA');
        }
      } catch (error) {
        console.error('USDA error:', error);
      }
    }

    // Try Nutritionix for missing data
    if (needsMoreData && this.API_KEYS.NUTRITIONIX_ID) {
      try {
        console.log('üì° Trying Nutritionix...');
        const nutritionixProduct = await this.fetchFromNutritionix(barcode);
        if (nutritionixProduct) {
          if (!product) {
            product = nutritionixProduct;
            source = 'Nutritionix';
          } else {
            product.product_name = product.product_name || nutritionixProduct.product_name;
            product.brands = product.brands || nutritionixProduct.brands;
            product.ingredients_text = product.ingredients_text || nutritionixProduct.ingredients_text;
            product.nutriments = mergeNutriments(product.nutriments, nutritionixProduct.nutriments);
            product.image_front_url = product.image_front_url || nutritionixProduct.image_front_url;
          }
          sourcesUsed.push('Nutritionix');
          console.log('‚úÖ Data from Nutritionix merged');
        }
      } catch (error) {
        console.error('Nutritionix error:', error);
      }
    }

    // Try Spoonacular for missing data
    if (needsMoreData && this.API_KEYS.SPOONACULAR) {
      try {
        console.log('üì° Trying Spoonacular...');
        const spoonProduct = await this.fetchFromSpoonacular(barcode);
        if (spoonProduct) {
          if (!product) {
            product = spoonProduct;
            source = 'Spoonacular';
          } else {
            product.product_name = product.product_name || spoonProduct.product_name;
            product.brands = product.brands || spoonProduct.brands;
            product.ingredients_text = product.ingredients_text || spoonProduct.ingredients_text;
            product.nutriments = mergeNutriments(product.nutriments, spoonProduct.nutriments);
          }
          sourcesUsed.push('Spoonacular');
          console.log('‚úÖ Data from Spoonacular merged');
        } else {
          console.log('‚ùå Not found in Spoonacular');
        }
      } catch (error) {
        console.error('Spoonacular error:', error);
      }
    }

    // Update source to show all APIs used
    if (sourcesUsed.length > 1) {
      source = sourcesUsed.join(' + ');
      console.log(`‚úÖ Data aggregated from: ${source}`);
    }

    // Process the product if found
    if (product) {
      // CHECK IF WE HAVE SUFFICIENT DATA TO SCORE
      const hasIngredients = !!(
        product.ingredients_text && 
        product.ingredients_text.trim().length > 10
      );
      
      const hasNutritionData = !!(
        product.nutriments && 
        product.nutriments['sugars_100g'] !== undefined &&
        product.nutriments['sodium_100g'] !== undefined
      );
      
      // Log what we have for debugging
      console.log('üìã Product data check:', {
        name: product.product_name,
        hasIngredients,
        hasNutritionData,
        source: source
      });
      
      // If missing critical data, return with "insufficient data" status
      if (!hasIngredients || !hasNutritionData) {
        console.log('‚ö†Ô∏è Insufficient data for scoring');
        return {
          name: product.product_name || 'Unknown Product',
          brand: product.brands || 'Unknown Brand',
          // NEW: Add image even for insufficient data
          image: this.getProductImage(product),
          healthScore: {
            score: 0,
            grade: '?',
            status: 'Insufficient Data',
            warnings: [{
              title: 'Product Not Fully in Database',
              description: `Missing ${!hasIngredients ? 'ingredients list' : 'nutrition data'}. Cannot provide complete health analysis. (Source: ${source})`,
              severity: 'info'
            }]
          },
          missingData: true,
          source: source,
          rawData: product
        };
      }
      
      // We have enough data - calculate health score
      console.log('üìä Calculating health score...');
      const healthScore = this.calculateHealthScore(product);
      console.log('‚úÖ Final grade:', healthScore.grade, 'Score:', healthScore.score);
      
      // NEW: Process additives with detailed information
      console.log('Additives tags:', product.additives_tags);
      const detailedAdditives = this.processDetailedAdditives(product.additives_tags || []);
      
      // NEW: Get positive attributes
      const positiveAttributes = this.getPositiveAttributes(product);
      
      // Return in format expected by App.js WITH NEW ENHANCEMENTS
      return {
        name: product.product_name || 'Unknown Product',
        brand: product.brands || 'Unknown Brand',
        
        // NEW: Image data
        image: this.getProductImage(product),
        imageUrl: product.image_front_url || product.image_url || null,
        
        // NEW: Enhanced additives information
        additives: detailedAdditives.all,
        criticalAdditives: detailedAdditives.critical,
        concerningAdditives: detailedAdditives.concerning,
        minorAdditives: detailedAdditives.minor,
        
        // NEW: Positive attributes
        positiveAttributes: positiveAttributes,
        healthScore: healthScore,
        // NEW: Additional product info
        ingredients: product.ingredients_text || '',
        categories: product.categories || '',

        // Nutrition data
        nutrition: {
          calories: product.nutriments?.['energy-kcal_100g'] || 0,
          sugar: product.nutriments?.['sugars_100g'] || 0,
          saturatedFat: product.nutriments?.['saturated-fat_100g'] || 0,
          sodium: product.nutriments?.['sodium_100g'] || 0,
          fiber: product.nutriments?.['fiber_100g'] || 0,
          protein: product.nutriments?.['proteins_100g'] || 0,
          carbs: product.nutriments?.['carbohydrates_100g'] || 0,
          fat: product.nutriments?.['fat_100g'] || 0
        },

        // Ingredients
        ingredients: product.ingredients_text || 'Not available',
        ingredientsList: product.ingredients || [],

        // Allergens
        allergens: product.allergens_tags || [],
        allergensList: product.allergens || '',

        // Additional data
        servingSize: product.serving_size || '100g',
        novaGroup: product.nova_group || null,
        nutriscoreGrade: product.nutriscore_grade || null,
        categories: product.categories || '',
        barcode: barcode,
        
        // NEW: Color coding for UI
        healthColor: this.getHealthColor(healthScore.grade),
        cardBackgroundColor: this.getCardBackgroundColor(healthScore.grade),
        
        // Existing fields
        healthScore: healthScore,
        missingData: false,
        source: source,
        rawData: product
      };
    }
    
    console.log('‚ùå Product not found in any database');
    return null;
  }

  /**
   * NEW FUNCTION: Get product image with fallback
   */
  static getProductImage(product) {
    // Priority order for images
    const imageUrl = product.image_front_url || 
                    product.image_url || 
                    product.image_front_small_url ||
                    product.image_small_url ||
                    product.image_thumb_url;
    
    // Return the image URL or placeholder
    return imageUrl || PLACEHOLDER_IMAGE;
  }

  /**
   * NEW FUNCTION: Process additives with detailed information
   */
  static processDetailedAdditives(additivesTags) {
    if (!additivesTags || additivesTags.length === 0) {
      return {
        all: [],
        critical: [],
        concerning: [],
        minor: []
      };
    }
    
    const processedAdditives = additivesTags.map((tag, index) => {
      // Handle Open Food Facts format (en:e150c) 
      let cleanTag = tag;
      if (tag.includes(':')) {
        cleanTag = tag.split(':')[1]; // Get e150c from en:e150c
      }
      
      const additiveInfo = getAdditiveInfo(cleanTag);
      return {
        ...additiveInfo,
        originalTag: tag,
        index: index + 1,
      };
    }).sort((a, b) => {
      const severityOrder = { high: 0, medium: 1, low: 2, unknown: 3 };
      return severityOrder[a.severity] - severityOrder[b.severity];
    });
    
    return {
      all: processedAdditives,
      critical: processedAdditives.filter(a => a.severity === 'high'),
      concerning: processedAdditives.filter(a => a.severity === 'medium'),
      minor: processedAdditives.filter(a => a.severity === 'low')
    };
  }

  /**
   * NEW FUNCTION: Get positive attributes of the product
   */
  static getPositiveAttributes(product) {
    const attributes = [];
    const ingredients = (product.ingredients_text || '').toLowerCase();
    const labels = (product.labels || '').toLowerCase();
    
    // Organic
    if (labels.includes('organic') || ingredients.includes('organic')) {
      attributes.push('USDA Organic certified');
    }
    
    // Low/No sugar
    const sugars = product.nutriments?.sugars_100g || 0;
    if (sugars === 0) {
      attributes.push('No sugar');
    } else if (sugars < 5) {
      attributes.push('Low sugar');
    }
    
    // Low sodium
    const sodium = product.nutriments?.sodium_100g || 0;
    if (sodium < 0.3) {
      attributes.push('Low sodium');
    }
    
    // High fiber
    const fiber = product.nutriments?.fiber_100g || 0;
    if (fiber > 6) {
      attributes.push('High fiber');
    } else if (fiber > 3) {
      attributes.push('Good source of fiber');
    }
    
    // High protein
    const protein = product.nutriments?.proteins_100g || 0;
    if (protein > 20) {
      attributes.push('High protein');
    } else if (protein > 10) {
      attributes.push('Good source of protein');
    }
    
    // Vegan/Vegetarian
    if (labels.includes('vegan')) {
      attributes.push('Vegan');
    } else if (labels.includes('vegetarian')) {
      attributes.push('Vegetarian');
    }
    
    // Non-GMO
    if (labels.includes('non-gmo') || labels.includes('non gmo')) {
      attributes.push('Non-GMO Project Verified');
    }
    
    // Gluten-free
    if (labels.includes('gluten-free') || labels.includes('gluten free')) {
      attributes.push('Certified Gluten-Free');
    }
    
    // No artificial additives
    if (!product.additives_tags || product.additives_tags.length === 0) {
      attributes.push('No artificial additives');
    }
    
    // Whole grain
    if (ingredients.includes('whole grain') || ingredients.includes('whole wheat')) {
      attributes.push('Contains whole grains');
    }
    
    // Low calorie
    const calories = product.nutriments?.['energy-kcal_100g'] || 0;
    if (calories === 0) {
      attributes.push('Zero calories');
    } else if (calories < 40) {
      attributes.push('Low calorie');
    }
    
    return attributes;
  }

  /**
   * NEW FUNCTION: Get color for UI based on grade
   */
  static getHealthColor(grade) {
    const colors = {
      'A': '#10B981',   // Green
      'A-': '#34D399',  // Light Green
      'B+': '#84CC16',  // Lime Green
      'B': '#A3E635',   // Light Lime
      'B-': '#BEF264',  // Pale Lime
      'C+': '#F59E0B',  // Yellow
      'C': '#FBBF24',   // Light Yellow
      'C-': '#FCD34D',  // Pale Yellow
      'D+': '#F97316',  // Orange
      'D': '#FB923C',   // Light Orange
      'D-': '#FDBA74',  // Pale Orange
      'F': '#EF4444'    // Red
    };
    return colors[grade] || '#6B7280'; // Gray for unknown
  }

  /**
   * NEW FUNCTION: Get background color for product card
   */
  static getCardBackgroundColor(grade) {
    const colors = {
      'A': '#DCFCE7',   // Light Green
      'A-': '#D1FAE5',  // Lighter Green
      'B+': '#ECFCCB',  // Light Lime
      'B': '#F0FDF4',   // Very Light Green
      'B-': '#F7FEE7',  // Pale Lime
      'C+': '#FEF3C7',  // Light Yellow
      'C': '#FEF9C3',   // Lighter Yellow
      'C-': '#FEFCE8',  // Pale Yellow
      'D+': '#FED7AA',  // Light Orange
      'D': '#FFEDD5',   // Lighter Orange
      'D-': '#FEF2E8',  // Pale Orange
      'F': '#FEE2E2'    // Light Red
    };
    return colors[grade] || '#F3F4F6'; // Light Gray for unknown
  }

  // ============================================
  // ALL YOUR EXISTING FUNCTIONS BELOW - UNCHANGED
  // ============================================

  /**
   * NEW: USDA FoodData Central API
   */
  static async fetchFromUSDA(barcode) {
    console.log('üîÑ USDA API call with key:', this.API_KEYS.USDA.substring(0, 10) + '...');
    const response = await fetch(
      `https://api.nal.usda.gov/fdc/v1/foods/search?query=${barcode}&api_key=${this.API_KEYS.USDA}`
    );
    
    console.log('USDA Response status:', response.status);
    if (response.status === 403) {
      console.error('‚ùå USDA API Key is invalid or expired!');
      throw new Error('Invalid USDA API key');
    }
    
    const data = await response.json();
    console.log('USDA found', data.foods?.length || 0, 'products');
    
    if (data.foods && data.foods.length > 0) {
      const food = data.foods[0];
      
      // Convert USDA format to Open Food Facts format
      const nutrients = {};
      if (food.foodNutrients) {
        food.foodNutrients.forEach(nutrient => {
          switch(nutrient.nutrientName) {
            case 'Sugars, total including NLEA':
            case 'Total Sugars':
              nutrients['sugars_100g'] = nutrient.value;
              break;
            case 'Sodium, Na':
              nutrients['sodium_100g'] = nutrient.value / 10; // Convert mg to per 100g
              break;
            case 'Fatty acids, total saturated':
              nutrients['saturated-fat_100g'] = nutrient.value;
              break;
            case 'Fiber, total dietary':
              nutrients['fiber_100g'] = nutrient.value;
              break;
            case 'Protein':
              nutrients['proteins_100g'] = nutrient.value;
              break;
            case 'Energy':
              nutrients['energy-kcal_100g'] = nutrient.value;
              break;
          }
        });
      }

      return {
        product_name: food.description,
        brands: food.brandOwner || food.brandName || 'Generic',
        nutriments: nutrients,
        ingredients_text: food.ingredients || '',
        categories: food.foodCategory || ''
      };
    }
    return null;
  }

  /**
   * Nutritionix API - FIXED VERSION
   */
  static async fetchFromNutritionix(barcode) {
    try {
      const response = await fetch(
        `https://trackapi.nutritionix.com/v2/search/item?upc=${barcode}`,
        {
          headers: {
            'x-app-id': this.API_KEYS.NUTRITIONIX_ID,
            'x-app-key': this.API_KEYS.NUTRITIONIX_KEY
          }
        }
      );
      
      // Check if response is OK
      if (!response.ok) {
        console.log('Nutritionix response not OK:', response.status);
        return null;
      }
      
      const data = await response.json();
      
      // Check if we have foods in the response
      if (!data || !data.foods || data.foods.length === 0) {
        console.log('‚ùå Not found in Nutritionix');
        return null;
      }
      
      const food = data.foods[0];
      
      // Ensure we have required fields before calculating
      if (!food.serving_weight_grams || food.serving_weight_grams === 0) {
        console.log('Missing serving weight in Nutritionix data');
        return null;
      }
      
      // Convert Nutritionix format to Open Food Facts format
      // Use safe calculation with fallbacks
      const servingWeight = food.serving_weight_grams || 100;
      
      return {
        product_name: food.food_name || 'Unknown Product',
        brands: food.brand_name || 'Unknown Brand',
        nutriments: {
          'sugars_100g': food.nf_sugars ? (food.nf_sugars / servingWeight) * 100 : 0,
          'sodium_100g': food.nf_sodium ? (food.nf_sodium / servingWeight) * 100 / 1000 : 0,
          'saturated-fat_100g': food.nf_saturated_fat ? (food.nf_saturated_fat / servingWeight) * 100 : 0,
          'fiber_100g': food.nf_dietary_fiber ? (food.nf_dietary_fiber / servingWeight) * 100 : 0,
          'proteins_100g': food.nf_protein ? (food.nf_protein / servingWeight) * 100 : 0,
          'energy-kcal_100g': food.nf_calories ? (food.nf_calories / servingWeight) * 100 : 0,
          'carbohydrates_100g': food.nf_total_carbohydrate ? (food.nf_total_carbohydrate / servingWeight) * 100 : 0,
          'fat_100g': food.nf_total_fat ? (food.nf_total_fat / servingWeight) * 100 : 0
        },
        ingredients_text: food.nf_ingredient_statement || '',
        categories: '',
        image_front_url: food.photo ? food.photo.thumb : null
      };
    } catch (error) {
      console.error('Nutritionix API error:', error);
      return null;
    }
  }

  /**
   * Spoonacular API - ENHANCED VERSION with proper formatting and additive detection
   */
  static async fetchFromSpoonacular(barcode) {
  const apiKey = '1f66fca067fe49bca59115e88fde84ac';
  const url = `https://api.spoonacular.com/food/products/upc/${barcode}?apiKey=${apiKey}`;
  
  try {
    console.log('üîç Fetching from Spoonacular for barcode:', barcode);
    console.log('üåê Full URL:', url);
    const response = await fetch(url);
    
    console.log('üì° Spoonacular response status:', response.status);
    
    if (!response.ok) {
      console.log('‚ùå Spoonacular response not OK:', response.status);
      return null;
    }
    
    const data = await response.json();
    
    // COMPLETE DEBUG LOGGING
    console.log('üî¥ ====================================');
    console.log('üî¥ COMPLETE SPOONACULAR RAW DATA:');
    console.log('üî¥ ====================================');
    console.log(JSON.stringify(data, null, 2));
    console.log('üî¥ ====================================');
    
    // Specific fields debug
    console.log('üì¶ PARSED SPOONACULAR FIELDS:');
    console.log('  Title:', data.title);
    console.log('  Brand:', data.brand);
    console.log('  Ingredients:', data.ingredientList);
    console.log('  Ingredient Count:', data.ingredientCount);
    console.log('  Image:', data.image);
    
    console.log('üìä NUTRITION OBJECT:');
    console.log('  Full nutrition:', JSON.stringify(data.nutrition, null, 2));
    console.log('  Calories:', data.nutrition?.calories);
    console.log('  Fat:', data.nutrition?.fat);
    console.log('  Sugar:', data.nutrition?.sugar);
    console.log('  Carbs:', data.nutrition?.carbs);
    console.log('  Protein:', data.nutrition?.protein);
    console.log('  Sodium:', data.nutrition?.sodium);
    
    // Check if nutrients array exists
    if (data.nutrition?.nutrients) {
      console.log('üìä NUTRIENTS ARRAY:');
      data.nutrition.nutrients.forEach(nutrient => {
        if (nutrient.name.toLowerCase().includes('sugar') || 
            nutrient.name.toLowerCase().includes('calor')) {
          console.log(`  - ${nutrient.name}: ${nutrient.amount} ${nutrient.unit}`);
        }
      });
    }
    
    // Check what we're converting
    console.log('üîÑ CONVERSION TO OUR FORMAT:');
    const sugarString = data.nutrition?.sugar || '0';
    console.log('  Sugar string:', sugarString);
    console.log('  Parsed sugar:', parseFloat(sugarString.replace('g', '')));
    
    if (!data || !data.title) {
      console.log('‚ùå Invalid Spoonacular data structure');
      return null;
    }

    console.log('‚úÖ Spoonacular raw data received');

    // Process ingredients to detect additives
    const ingredientsText = data.ingredientList || '';
    const ingredientsLower = ingredientsText.toLowerCase();
    
    // Enhanced additive detection
    const detectedAdditives = [];
    const additivePatterns = [
      /\be\d{3}[a-z]?\b/gi,
      /\b(lecithin|vanillin|maltodextrin|dextrose|xanthan|guar|carrageenan|citric acid|ascorbic acid|tocopherol|caramel color|annatto)\b/gi,
      /\b(artificial|imitation|synthetic)\s+\w+/gi,
      /\b(sodium benzoate|potassium sorbate|bha|bht|tbhq|sodium nitrite)\b/gi,
      /\b(aspartame|sucralose|saccharin|acesulfame|stevia|sorbitol|xylitol)\b/gi,
      /\b(msg|monosodium glutamate|disodium inosinate|disodium guanylate|autolyzed yeast)\b/gi
    ];
    
    additivePatterns.forEach(pattern => {
      const matches = ingredientsText.match(pattern);
      if (matches) {
        matches.forEach(match => {
          if (!detectedAdditives.includes(match.toLowerCase())) {
            detectedAdditives.push(match.toLowerCase());
          }
        });
      }
    });

    // Determine NOVA level based on ingredients
    let novaLevel = 1;
    
    if (ingredientsLower.includes('artificial') || 
        ingredientsLower.includes('modified') ||
        ingredientsLower.includes('hydrogenated') ||
        detectedAdditives.length > 5) {
      novaLevel = 4;
    } else if (detectedAdditives.length > 2 || 
               ingredientsLower.includes('preservative')) {
      novaLevel = 3;
    } else if (data.ingredientCount > 5) {
      novaLevel = 2;
    }
// FIX: Force NOVA 4 for obvious ultra-processed products like sodas
if (ingredientsLower.includes('carbonated') && ingredientsLower.includes('sugar') && 
    (ingredientsLower.includes('caramel') || ingredientsLower.includes('phosphoric'))) {
  novaLevel = 4;
  console.log('üî¥ OVERRIDE: Forcing NOVA 4 for soda/cola product');
}

// FIX: Detect Natural Flavoring as harmful
if (ingredientsLower.includes('natural flavour') || ingredientsLower.includes('natural flavor')) {
  if (!detectedAdditives.includes('natural flavoring')) {
    detectedAdditives.push('natural flavoring');
    console.log('‚ö†Ô∏è Added Natural Flavoring to harmful additives');
  }
}
    // Get nutrition data if available
    const nutrition = data.nutrition || {};
    const nutrients = nutrition.nutrients || [];
    
    // Parse sugar value - CHECK MULTIPLE POSSIBLE FORMATS
    let sugarValue = 0;
    if (nutrition.sugar) {
      sugarValue = parseFloat(nutrition.sugar.replace(/[^0-9.]/g, ''));
      console.log('üç¨ Sugar from nutrition.sugar:', sugarValue);
    } else if (nutrients.length > 0) {
      const sugarNutrient = nutrients.find(n => 
        n.name.toLowerCase().includes('sugar') && 
        !n.name.toLowerCase().includes('added')
      );
      if (sugarNutrient) {
        sugarValue = sugarNutrient.amount || 0;
        console.log('üç¨ Sugar from nutrients array:', sugarValue);
      }
    }
    
    // Format the product data properly
    const formattedProduct = {
      product_name: data.title,
      brands: data.brand || 'Unknown Brand',
      
      nutriments: {
        'calories': Math.round((nutrition.calories || 0) * 10) / 10,
        'fat_100g': Math.round(parseFloat(nutrition.fat?.replace('g', '') || 0) * 10) / 10,
        'saturated-fat_100g': Math.round(parseFloat(nutrition.saturatedFat?.replace('g', '') || 0) * 10) / 10,
        'carbohydrates_100g': Math.round(parseFloat(nutrition.carbs?.replace('g', '') || 0) * 10) / 10,
        'sugars_100g': Math.round(sugarValue * 10) / 10,
        'fiber_100g': Math.round(parseFloat(nutrition.fiber?.replace('g', '') || 0) * 10) / 10,
        'proteins_100g': Math.round(parseFloat(nutrition.protein?.replace('g', '') || 0) * 10) / 10,
        'sodium_100g': Math.round(parseFloat(nutrition.sodium?.replace('mg', '') || 0) / 1000 * 10) / 10,
        'energy-kcal_100g': Math.round((nutrition.calories || 0) * 10) / 10
      },
      
      ingredients_text: ingredientsText
        .split(',')
        .map(ing => {
          return ing.trim()
            .toLowerCase()
            .replace(/\b\w/g, char => char.toUpperCase());
        })
        .join(', '),
      
      additives_tags: detectedAdditives.map(add => `en:${add.replace(/\s+/g, '-')}`),
      nova_group: novaLevel,
      image_front_url: data.image || null,
      source: 'spoonacular'
    };

    console.log('üì¶ FORMATTED product:', JSON.stringify(formattedProduct, null, 2));
    console.log('üß™ Detected additives:', detectedAdditives);
    console.log('üè∑Ô∏è NOVA level:', novaLevel);
    console.log('üç¨ FINAL SUGAR VALUE:', formattedProduct.nutriments.sugars_100g);
    
    return formattedProduct;
    
  } catch (error) {
    console.error('‚ùå Spoonacular fetch error:', error);
    return null;
  }
}
  // YOUR EXISTING checkUserAllergens FUNCTION - UNCHANGED
  static checkUserAllergens(product, userFilters) {
    const warnings = [];
    const ingredients = (product.ingredients_text || '').toLowerCase();
    
    // Map user filters to allergen keywords
    const allergenMap = {
      'gluten-free': {
        keywords: ['wheat', 'barley', 'rye', 'gluten', 'flour', 'bread'],
        warning: 'Contains Gluten'
      },
      'dairy-free': {
        keywords: ['milk', 'cheese', 'butter', 'yogurt', 'cream', 'whey', 'casein', 'lactose'],
        warning: 'Contains Dairy'
      },
      'tree-nuts': {
        keywords: ['almond', 'cashew', 'walnut', 'pecan', 'pistachio', 'hazelnut', 'macadamia', 'brazil nut'],
        warning: 'Contains Tree Nuts'
      },
      'peanuts': {
        keywords: ['peanut', 'groundnut', 'arachis'],
        warning: 'Contains Peanuts'
      },
      'soy-free': {
        keywords: ['soy', 'soya', 'soybeans', 'tofu', 'tempeh', 'miso'],
        warning: 'Contains Soy'
      },
      'eggs': {
        keywords: ['egg', 'albumin', 'mayonnaise', 'meringue'],
        warning: 'Contains Eggs'
      },
      'shellfish': {
        keywords: ['shrimp', 'crab', 'lobster', 'shellfish', 'prawn', 'crawfish'],
        warning: 'Contains Shellfish'
      },
      'fish': {
        keywords: ['fish', 'salmon', 'tuna', 'cod', 'anchovy', 'sardine', 'trout'],
        warning: 'Contains Fish'
      },
      'no-dyes': {
        keywords: ['red 40', 'yellow 5', 'yellow 6', 'blue 1', 'red 3', 'e129', 'e102', 'e110', 'e133', 'e127', 
                   'artificial color', 'fd&c', 'food coloring', 'food dye'],
        warning: 'Contains Artificial Dyes'
      },
      'low-sugar': {
        keywords: ['high fructose corn syrup', 'corn syrup', 'dextrose', 'maltose', 'sucrose'],
        warning: 'High Sugar Content',
        checkNutrients: true,
        nutrientThreshold: 10 // grams per 100g
      },
      'low-sodium': {
        keywords: ['salt', 'sodium'],
        warning: 'High Sodium Content',
        checkNutrients: true,
        nutrientThreshold: 400 // mg per 100g
      },
      'no-msg': {
        keywords: ['msg', 'monosodium glutamate', 'e621', 'glutamate', 'yeast extract'],
        warning: 'Contains MSG'
      }
    };

    // Check each active filter
    userFilters.forEach(filter => {
      const filterData = allergenMap[filter];
      if (!filterData) return;

      // Check ingredients text
      let found = false;
      if (filterData.keywords) {
        found = filterData.keywords.some(keyword => ingredients.includes(keyword));
      }

      // Check nutrient levels for sugar/sodium filters
      if (filterData.checkNutrients && product.nutriments) {
        if (filter === 'low-sugar' && product.nutriments['sugars_100g'] > filterData.nutrientThreshold) {
          found = true;
        }
        if (filter === 'low-sodium' && product.nutriments['sodium_100g'] > filterData.nutrientThreshold) {
          found = true;
        }
      }

      // Add warning if allergen/restriction is violated
      if (found) {
        warnings.push({
          title: `‚ö†Ô∏è ${filterData.warning}`,
          description: `This product contains ingredients you've marked to avoid in your profile settings.`,
          severity: 'critical'
        });
      }
    });

    return warnings;
  }

  // ALL YOUR OTHER EXISTING FUNCTIONS BELOW - COMPLETELY UNCHANGED
  
  /**
   * Determine if product is liquid based on categories
   */
  static isProductLiquid(product) {
    const liquidCategories = [
      'beverages', 'drinks', 'sodas', 'juices', 'waters', 'milk', 
      'plant-based-milk', 'coffee', 'tea', 'energy-drinks', 'sports-drinks',
      'alcoholic-beverages', 'beers', 'wines', 'spirits', 'yogurts'
    ];
    
    const categories = (product.categories || '').toLowerCase();
    const productName = (product.product_name || '').toLowerCase();
    
    // Check categories
    for (const liquidCat of liquidCategories) {
      if (categories.includes(liquidCat)) {
        return true;
      }
    }
    
    // Check product name for liquid indicators
    const liquidIndicators = ['drink', 'juice', 'water', 'milk', 'cola', 'soda', 'beverage', 'yogurt', 'yoghurt'];
    for (const indicator of liquidIndicators) {
      if (productName.includes(indicator)) {
        return true;
      }
    }
    
    return false;
  }

  /**
   * Determine NOVA processing level (1-4)
   */
  static getNOVALevel(product) {
    // If NOVA group is provided by Open Food Facts
    if (product.nova_group) {
      return parseInt(product.nova_group);
    }
    
    // Otherwise, estimate based on ingredients
    const ingredients = (product.ingredients_text || '').toLowerCase();
    const ingredientsList = product.ingredients || [];
    const ingredientCount = ingredientsList.length || 0;
    
    // Check for additives (E-numbers)
    const hasENumbers = /\bE\d{3}\b/i.test(ingredients);
    
    // Ultra-processed indicators
    const ultraProcessedMarkers = [
      'artificial flavor', 'natural flavor', 'modified starch', 'high fructose corn syrup',
      'corn syrup', 'hydrogenated', 'partially hydrogenated', 'maltodextrin',
      'dextrose', 'emulsifier', 'stabilizer', 'color', 'colour', 'preservative',
      'antioxidant', 'aspartame', 'sucralose', 'acesulfame', 'saccharin'
    ];
    
    let hasUltraProcessedMarkers = false;
    for (const marker of ultraProcessedMarkers) {
      if (ingredients.includes(marker)) {
        hasUltraProcessedMarkers = true;
        break;
      }
    }
    
    // Determine NOVA level based on ingredients
    if (ingredientCount > 5 && (hasUltraProcessedMarkers || hasENumbers)) {
      return 4; // Ultra-processed
    } else if (ingredientCount >= 3 && ingredientCount <= 5) {
      return 3; // Processed
    } else if (ingredientCount === 2) {
      return 2; // Processed culinary ingredients
    } else {
      return 1; // Unprocessed or minimally processed
    }
  }

  /**
   * ENHANCED HARMFUL ADDITIVES DETECTION - Case insensitive with comprehensive matching
   */
  static checkHarmfulAdditives(product) {
    // Get ingredients and convert to lowercase for checking
    const ingredientsOriginal = product.ingredients_text || '';
    const ingredients = ingredientsOriginal.toLowerCase().replace(/[,;]/g, ' ');
    
    // Also check product name for sneaky additions
    const productName = (product.product_name || '').toLowerCase();
    const fullText = `${ingredients} ${productName}`;
    
    let totalPenalty = 0;
    const warnings = [];
    const foundIngredients = new Set(); // Prevent duplicates
    
    console.log('üîç Checking ingredients for harmful additives...');
    console.log('üìù Original ingredients:', ingredientsOriginal);
    console.log('üìù Normalized for checking:', ingredients);
    
    // Check Comprehensive Harmful Ingredients Database
    for (const category in HARMFUL_INGREDIENTS_DATABASE) {
      const items = HARMFUL_INGREDIENTS_DATABASE[category];
      
      for (const key in items) {
        const item = items[key];
        const itemKey = `${category}-${key}`;
        
        // Skip if already found
        if (foundIngredients.has(itemKey)) continue;
        
        // Create array of terms to check (main key + all aliases)
        const termsToCheck = [key];
        if (item.aliases && item.aliases.length > 0) {
          termsToCheck.push(...item.aliases);
        }
        
        // Check each term
        let found = false;
        let matchedTerm = '';
        
        for (const term of termsToCheck) {
          // Use different matching strategies
          if (this.checkIngredientMatch(ingredients, term)) {
            found = true;
            matchedTerm = term;
            break;
          }
        }
        
        // If found, add to warnings
        if (found) {
          foundIngredients.add(itemKey);
          totalPenalty += item.penalty;
          
          warnings.push({
            title: item.name,
            description: item.concern,
            severity: this.getSeverityLevel(item.penalty),
            category: category.replace(/([A-Z])/g, ' $1').trim()
          });
          
          console.log(`‚ö†Ô∏è Found harmful ingredient: ${item.name} (matched: "${matchedTerm}")`);
        }
      }
    }
    
    // Check for E-numbers pattern
    const eNumberPattern = /\b[eE]\s*\d{3}[a-zA-Z]?\b/g;
    const eNumbers = ingredients.match(eNumberPattern) || [];
    
    for (const eNumber of eNumbers) {
      const normalized = eNumber.toLowerCase().replace(/\s/g, '');
      const eInfo = getAdditiveInfo(`en:${normalized}`);
      
      if (eInfo && eInfo.severity === 'high' && !foundIngredients.has(`e-${normalized}`)) {
        foundIngredients.add(`e-${normalized}`);
        
        // Assign penalty based on severity
        const ePenalty = eInfo.severity === 'high' ? 8 : 
                         eInfo.severity === 'medium' ? 5 : 2;
        totalPenalty += ePenalty;
        
        warnings.push({
          title: `${eInfo.name} (${eInfo.code})`,
          description: eInfo.healthImpact || eInfo.description,
          severity: eInfo.severity,
          category: 'E-Number Additive'
        });
        
        console.log(`‚ö†Ô∏è Found E-number: ${eInfo.code} - ${eInfo.name}`);
      }
    }
    
    // Special checks for commonly missed items
    // Check for various forms of corn syrup
    const cornSyrupVariations = [
      'corn syrup', 'corn-syrup', 'corn syrup solids', 'glucose syrup',
      'glucose-fructose', 'glucose fructose', 'maize syrup'
    ];
    
    for (const variant of cornSyrupVariations) {
      if (ingredients.includes(variant) && !foundIngredients.has('corn-syrup-special')) {
        foundIngredients.add('corn-syrup-special');
        
        // Only add if not already caught by main database
        const alreadyHasCornSyrup = warnings.some(w => 
          w.title.toLowerCase().includes('corn syrup') || 
          w.title.toLowerCase().includes('hfcs')
        );
        
        if (!alreadyHasCornSyrup) {
          totalPenalty += 8;
          warnings.push({
            title: 'Corn Syrup',
            description: 'High glycemic index, often from GMO corn, linked to obesity',
            severity: 'medium',
            category: 'Sugar/Syrup'
          });
          console.log(`‚ö†Ô∏è Found corn syrup variant: "${variant}"`);
        }
      }
    }
    
    // Check for phosphates (often missed)
    const phosphateVariations = [
      'phosphate', 'phosphoric acid', 'trisodium phosphate', 'sodium phosphate',
      'disodium phosphate', 'monocalcium phosphate', 'calcium phosphate'
    ];
    
    for (const phosphate of phosphateVariations) {
      if (ingredients.includes(phosphate) && !foundIngredients.has(`phosphate-${phosphate}`)) {
        foundIngredients.add(`phosphate-${phosphate}`);
        
        // Check if already added
        const alreadyHasPhosphate = warnings.some(w => 
          w.title.toLowerCase().includes('phosphate')
        );
        
        if (!alreadyHasPhosphate) {
          totalPenalty += 6;
          warnings.push({
            title: 'Phosphate Additive',
            description: 'May interfere with calcium absorption, linked to kidney issues',
            severity: 'medium',
            category: 'Mineral Additive'
          });
          console.log(`‚ö†Ô∏è Found phosphate: "${phosphate}"`);
        }
      }
    }
    
    // Sort warnings by severity
    warnings.sort((a, b) => {
      const severityOrder = { critical: 0, high: 1, medium: 2, low: 3, info: 4 };
      return (severityOrder[a.severity] || 4) - (severityOrder[b.severity] || 4);
    });
    
    console.log(`üìä Total harmful ingredients found: ${warnings.length}`);
    console.log(`üìä Total penalty points: ${totalPenalty}`);
    
    return { 
      penalty: totalPenalty, 
      warnings: warnings
    };
  }

  /**
   * HELPER FUNCTION: Smart ingredient matching
   * Handles various formats and partial matches
   */
  static checkIngredientMatch(ingredients, searchTerm) {
    // Normalize search term
    const term = searchTerm.toLowerCase().trim();
    
    // Direct match
    if (ingredients.includes(term)) {
      return true;
    }
    
    // Check with word boundaries for exact word match
    const wordBoundaryPattern = new RegExp(`\\b${this.escapeRegex(term)}\\b`, 'i');
    if (wordBoundaryPattern.test(ingredients)) {
      return true;
    }
    
    // Check with spaces, hyphens, and parentheses
    const variations = [
      term.replace(/ /g, '-'),  // space to hyphen
      term.replace(/-/g, ' '),  // hyphen to space
      term.replace(/ /g, ''),   // remove spaces
    ];
    
    for (const variant of variations) {
      if (ingredients.includes(variant)) {
        return true;
      }
    }
    
    // Check if it appears with common prefixes/suffixes
    const modifiedVersions = [
      `modified ${term}`,
      `${term} extract`,
      `${term} powder`,
      `natural ${term}`,
      `artificial ${term}`,
      `${term} flavoring`,
      `${term} flavor`
    ];
    
    for (const modified of modifiedVersions) {
      if (ingredients.includes(modified)) {
        return true;
      }
    }
    
    return false;
  }

  /**
   * HELPER: Escape special regex characters
   */
  static escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  /**
   * HELPER: Convert penalty points to severity level
   */
  static getSeverityLevel(penalty) {
    if (penalty >= 15) return 'critical';
    if (penalty >= 8) return 'high';
    if (penalty >= 5) return 'medium';
    if (penalty >= 3) return 'low';
    return 'info';
  }

  /**
   * Main scoring algorithm - Evidence-based nutritional assessment
   * ENHANCED VERSION: Harsh penalties + Generous bonuses for whole foods
   */
  static calculateHealthScore(product) {
    // Start with perfect score
    let score = 100;
    const warnings = [];
    
    // Get nutritional values per 100g/100ml
    const nutriments = product.nutriments || {};
    
    // Determine if liquid or solid
    const isLiquid = this.isProductLiquid(product);
    const unit = isLiquid ? '100ml' : '100g';
    
    // Extract nutritional values
    const sugar = nutriments['sugars_100g'] || 0;
    const saturatedFat = nutriments['saturated-fat_100g'] || 0;
    const sodium = nutriments['sodium_100g'] || 0;
    const fiber = nutriments['fiber_100g'] || 0;
    const proteins = nutriments['proteins_100g'] || 0;
    const energy = nutriments['energy-kcal_100g'] || 0;
    
  // CRITICAL SAFETY CHECK - Flag extreme products
let isSafetyOverride = false;
if (sugar > 30 || saturatedFat > 10) {
  console.log('‚ö†Ô∏è SAFETY OVERRIDE: Extreme sugar or fat detected');
  console.log(`Sugar: ${sugar}g, Saturated Fat: ${saturatedFat}g`);
  isSafetyOverride = true;
}

    // Get ingredients info
    const ingredients = (product.ingredients_text || '').toLowerCase();
    const ingredientsList = product.ingredients || [];
    
    // SPECIAL HANDLING FOR LOW-CALORIE CONDIMENTS
    const isLowCalorieProduct = energy < 10;
    if (isLowCalorieProduct && ingredientsList.length < 10 && sodium < 500) {
      // Simple condiment - start with good base score
      score = 85;
      
      // Only apply sodium penalty if actually high
      if (sodium > 1000) {
        score -= 20;
        warnings.push({
          title: 'High Sodium for Condiment',
          description: `${sodium.toFixed(0)}mg per ${unit}`,
          severity: 'medium'
        });
      }
      
      // Bonus for organic
      if (ingredients.includes('organic')) {
        score += 10;
      }
      
      // Still check for harmful additives
      const additiveCheck = this.checkHarmfulAdditives(product);
      score -= additiveCheck.penalty;
      warnings.push(...additiveCheck.warnings);
      
      // Calculate final grade and return early for condiments
      score = Math.max(0, Math.min(100, score));
      
      let grade, status;
      if (score >= 90) {
        grade = 'A';
        status = 'Excellent Choice';
      } else if (score >= 80) {
        grade = 'A-';
        status = 'Very Good Choice';
      } else if (score >= 75) {
        grade = 'B+';
        status = 'Good Choice';
      } else if (score >= 70) {
        grade = 'B';
        status = 'Moderate - Some Concerns';
      } else if (score >= 65) {
        grade = 'B-';
        status = 'Moderate - Multiple Concerns';
      } else if (score >= 60) {
        grade = 'C+';
        status = 'Poor - Several Issues';
      } else if (score >= 55) {
        grade = 'C';
        status = 'Poor - Many Concerns';
      } else if (score >= 50) {
        grade = 'C-';
        status = 'Poor - Significant Issues';
      } else if (score >= 45) {
        grade = 'D+';
        status = 'Avoid - Unhealthy';
      } else if (score >= 40) {
        grade = 'D';
        status = 'Avoid - Very Unhealthy';
      } else if (score >= 30) {
        grade = 'D-';
        status = 'Avoid - Multiple Health Risks';
      } else {
        grade = 'F';
        status = 'Avoid - Serious Health Concerns';
      }
      
      return {
        score: Math.round(score),
        grade: grade,
        status: status,
        warnings: warnings
      };
    }
    
    // REGULAR SCORING FOR NON-CONDIMENT PRODUCTS
    
    // 1. USE NUTRI-SCORE AS BASE IF AVAILABLE
    if (product.nutriscore_grade) {
      const nutriScoreMap = {
        'a': 100, 'b': 85, 'c': 70, 'd': 55, 'e': 40
      };
      const grade = product.nutriscore_grade.toLowerCase();
      if (nutriScoreMap[grade] !== undefined) {
        score = nutriScoreMap[grade];
      }
    }
    
    // 2. NOVA PROCESSING LEVEL PENALTY (KEEP HARSH)
    const novaLevel = this.getNOVALevel(product);
    if (novaLevel === 4) {
      score -= 20;
      warnings.push({
        title: 'Ultra-Processed Food',
        description: 'Linked to 29% increased mortality risk (BMJ 2019)',
        severity: 'high'
      });
    } else if (novaLevel === 3) {
      score -= 10;
      warnings.push({
        title: 'Processed Food',
        description: 'Contains added ingredients for flavor and preservation',
        severity: 'medium'
      });
    } else if (novaLevel === 2) {
      score -= 5;
    }
    
    // 3. SUGAR PENALTIES (KEEP HARSH - Different thresholds for liquids vs solids)
    if (isLiquid) {
      // Liquid sugar thresholds (per 100ml)
      if (sugar > 10) {
        score -= 35;
        warnings.push({
          title: `Extreme Sugar Content`,
          description: `${sugar.toFixed(1)}g per ${unit} - exceeds WHO daily limit in one serving!`,
          severity: 'critical'
        });
      } else if (sugar > 8) {
        score -= 25;
        warnings.push({
          title: `Very High Sugar`,
          description: `${sugar.toFixed(1)}g per ${unit} - UK sugar tax tier 2`,
          severity: 'high'
        });
      } else if (sugar > 5) {
        score -= 15;
        warnings.push({
          title: `High Sugar`,
          description: `${sugar.toFixed(1)}g per ${unit} - UK sugar tax tier 1`,
          severity: 'medium'
        });
      } else if (sugar > 2.5) {
        score -= 5;
        warnings.push({
          title: `Moderate Sugar`,
          description: `${sugar.toFixed(1)}g per ${unit}`,
          severity: 'low'
        });
      }
    } else {
      // Solid sugar thresholds (per 100g)
      if (sugar > 22.5) {
        score -= 40;
        warnings.push({
          title: `Extreme Sugar Content`,
          description: `${sugar.toFixed(1)}g per ${unit} - major health risk!`,
          severity: 'critical'
        });
      } else if (sugar > 15) {
        score -= 30;
        warnings.push({
          title: `Very High Sugar`,
          description: `${sugar.toFixed(1)}g per ${unit} - exceeds UK "high sugar" threshold`,
          severity: 'high'
        });
      } else if (sugar > 10) {
        score -= 20;
        warnings.push({
          title: `High Sugar`,
          description: `${sugar.toFixed(1)}g per ${unit} - exceeds WHO recommendation`,
          severity: 'medium'
        });
      } else if (sugar > 5) {
        score -= 10;
        warnings.push({
          title: `Moderate Sugar`,
          description: `${sugar.toFixed(1)}g per ${unit}`,
          severity: 'low'
        });
      }
    }
    
    // 4. SODIUM PENALTIES (KEEP HARSH)
    if (isLiquid) {
      // Liquid sodium (per 100ml)
      if (sodium > 200) {
        score -= 20;
        warnings.push({
          title: `Very High Sodium`,
          description: `${sodium.toFixed(0)}mg per ${unit} - significant health concern`,
          severity: 'high'
        });
      } else if (sodium > 140) {
        score -= 10;
        warnings.push({
          title: `High Sodium`,
          description: `${sodium.toFixed(0)}mg per ${unit}`,
          severity: 'medium'
        });
      } else if (sodium > 40) {
        score -= 5;
        warnings.push({
          title: `Moderate Sodium`,
          description: `${sodium.toFixed(0)}mg per ${unit}`,
          severity: 'low'
        });
      }
    } else {
      // Solid sodium (per 100g)
      if (sodium > 1000) {
        score -= 35;
        warnings.push({
          title: `Extreme Sodium`,
          description: `${sodium.toFixed(0)}mg per ${unit} - major cardiovascular risk!`,
          severity: 'critical'
        });
      } else if (sodium > 600) {
        score -= 25;
        warnings.push({
          title: `Very High Sodium`,
          description: `${sodium.toFixed(0)}mg per ${unit} - exceeds EU threshold`,
          severity: 'high'
        });
      } else if (sodium > 400) {
        score -= 15;
        warnings.push({
          title: `High Sodium`,
          description: `${sodium.toFixed(0)}mg per ${unit} - FDA "high sodium"`,
          severity: 'medium'
        });
      } else if (sodium > 140) {
        score -= 5;
        warnings.push({
          title: `Moderate Sodium`,
          description: `${sodium.toFixed(0)}mg per ${unit}`,
          severity: 'low'
        });
      }
    }
    
    // 5. SATURATED FAT PENALTIES (KEEP HARSH - for solids)
    if (!isLiquid && saturatedFat > 0) {
      if (saturatedFat > 10) {
        score -= 35;
        warnings.push({
          title: `Extreme Saturated Fat`,
          description: `${saturatedFat.toFixed(1)}g per ${unit} - major cardiovascular risk!`,
          severity: 'critical'
        });
      } else if (saturatedFat > 5) {
        score -= 25;
        warnings.push({
          title: `Very High Saturated Fat`,
          description: `${saturatedFat.toFixed(1)}g per ${unit} - exceeds 25% daily value`,
          severity: 'high'
        });
      } else if (saturatedFat > 3) {
        score -= 15;
        warnings.push({
          title: `High Saturated Fat`,
          description: `${saturatedFat.toFixed(1)}g per ${unit} - EU "high saturated fat"`,
          severity: 'medium'
        });
      } else if (saturatedFat > 1.5) {
        score -= 5;
        warnings.push({
          title: `Moderate Saturated Fat`,
          description: `${saturatedFat.toFixed(1)}g per ${unit}`,
          severity: 'low'
        });
      }
    }
    
    // 6. CHECK FOR HARMFUL ADDITIVES (ENHANCED)
    const additiveCheck = this.checkHarmfulAdditives(product);
    score -= additiveCheck.penalty;
    warnings.push(...additiveCheck.warnings);
    
// REPLACE THE ENTIRE POSITIVE MODIFIERS SECTION
// Find: "// 7. POSITIVE MODIFIERS" or "// 7. ENHANCED POSITIVE MODIFIERS"
// Replace with this EXACT implementation from Framework v2.1:

    // ===========================================================
    // 7. POSITIVE MODIFIERS (max +20 total per Framework v2.1)
    // ===========================================================
    let bonusPoints = 0;
    
    // High fiber bonus (max 8 points per framework)
    if (fiber > 6) {
      bonusPoints += 8;
    } else if (fiber > 3) {
      bonusPoints += 4;
    }
    
    // High protein bonus (max 7 points per framework)
    if (proteins > 10) {
      bonusPoints += 7;
    } else if (proteins > 5) {
      bonusPoints += 3;
    }
    
    // Check for whole grains in ingredients (+5 per framework)
    if (ingredients.includes('whole grain') || ingredients.includes('whole wheat')) {
      bonusPoints += 5;
    }
    
    // Organic bonus (+3 per framework)
    if (ingredients.includes('organic')) {
      bonusPoints += 3;
    }
    
    // CRITICAL: Cap bonus at 20 as per Framework v2.1
    bonusPoints = Math.min(bonusPoints, 20);
    
    console.log(`üìä Bonuses applied: ${bonusPoints} (capped at 20)`);
    
    score += bonusPoints;
    
    // Ensure score stays within 0-100 range
    score = Math.max(0, Math.min(100, score));
    
    // Calculate letter grade based on final score
    let grade, status;
    if (score >= 90) {
      grade = 'A';
      status = 'Excellent Choice';
    } else if (score >= 80) {
      grade = 'A-';
      status = 'Very Good Choice';
    } else if (score >= 75) {
      grade = 'B+';
      status = 'Good Choice';
    } else if (score >= 70) {
      grade = 'B';
      status = 'Moderate - Some Concerns';
    } else if (score >= 65) {
      grade = 'B-';
      status = 'Moderate - Multiple Concerns';
    } else if (score >= 60) {
      grade = 'C+';
      status = 'Poor - Several Issues';
    } else if (score >= 55) {
      grade = 'C';
      status = 'Poor - Many Concerns';
    } else if (score >= 50) {
      grade = 'C-';
      status = 'Poor - Significant Issues';
    } else if (score >= 45) {
      grade = 'D+';
      status = 'Avoid - Unhealthy';
    } else if (score >= 40) {
      grade = 'D';
      status = 'Avoid - Very Unhealthy';
    } else if (score >= 30) {
      grade = 'D-';
      status = 'Avoid - Multiple Health Risks';
    } else {
      grade = 'F';
      status = 'Avoid - Serious Health Concerns';
    }
    
    // Apply safety cap for extreme products
    if (isSafetyOverride && score > 30) {
      console.log(`SAFETY CAP APPLIED: Score ${score} reduced to 30 due to extreme sugar/fat`);
      score = 30;
      // Force recalculate grade for capped score
      if (score >= 45) {
        grade = 'D+';
        status = 'Avoid - Unhealthy';
      } else if (score >= 40) {
        grade = 'D';
        status = 'Avoid - Very Unhealthy';  
      } else if (score >= 30) {
        grade = 'D-';
        status = 'Avoid - Multiple Health Risks';
      } else {
        grade = 'F';
        status = 'Avoid - Serious Health Concerns';
      }
    }

    console.log(`‚úÖ Final grade: ${grade} Score: ${score}`);

    // Return score object in format expected by App.js
    return {
      score: Math.round(score),
      grade: grade,
      status: status,
      warnings: warnings.sort((a, b) => {
        // Sort warnings by severity
        const severityOrder = { critical: 0, high: 1, medium: 2, low: 3, info: 4 };
        return (severityOrder[a.severity] || 4) - (severityOrder[b.severity] || 4);
      })
    };
  }
}

export default ProductService;